<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Two-Thumb Pong</title>
<style>
  :root{
    --bg:#0b1020;
    --fg:#ffffff;
    --muted:#b7c2ff;
    --accent:#5b8cff;
    --danger:#ff4d4d;
    --ok:#33d17a;
    --shadow:0 8px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;height:100%;background:var(--bg);color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  /* Prevent scroll/selection on mobile */
  body{overscroll-behavior:none; touch-action:none; -webkit-user-select:none; user-select:none}
  #wrap{
    position:fixed; inset:0;
    min-height:100dvh; /* mobile Safari dynamic bar safe */
    display:grid; place-items:center;
  }
  canvas#game{
    position:fixed; inset:0;
    width:100vw; height:100dvh;
    display:block;
    touch-action:none;
  }
  /* HUD */
  .hud{
    position:fixed; inset:0; pointer-events:none;
  }
  .row{
    display:flex; align-items:center; justify-content:space-between;
    padding:calc(env(safe-area-inset-top,0px) + 10px) 12px 10px 12px;
    gap:8px;
  }
  .score{
    pointer-events:none; font-weight:700; letter-spacing:.3px;
    font-variant-numeric: tabular-nums;
    text-shadow: 0 2px 0 rgba(0,0,0,.3);
  }
  .score .big{font-size:28px; line-height:1}
  .score .small{font-size:12px; color:var(--muted)}
  .btn{
    pointer-events:auto;
    -webkit-tap-highlight-color: transparent;
    appearance:none; border:0; border-radius:12px;
    padding:12px 14px; min-width:44px; min-height:44px;
    background:#151c35; color:var(--fg); box-shadow:var(--shadow);
    font-weight:600; font-size:14px; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#0f1530}
  .btn.red{background: #2a0f16; color:#ffd6d6}
  .btn.green{background:#0e2a1d; color:#d6ffea}
  .cluster{display:flex; gap:8px}
  /* Bottom center CTA when idle */
  .bottom-cta{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(env(safe-area-inset-bottom,0px) + 18px);
    pointer-events:none;
  }
  .bottom-cta .btn{pointer-events:auto; font-size:16px; padding:14px 18px}
  /* Overlays */
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center;
    background:rgba(5,8,20,.64); backdrop-filter: blur(6px);
    padding:24px; z-index:5;
  }
  .panel{
    width:min(92vw, 520px); border-radius:16px; background:#0e1735; color:var(--fg);
    box-shadow: var(--shadow); padding:20px;
  }
  .panel h1{margin:0 0 6px 0; font-size:22px}
  .panel p{margin:8px 0; color:var(--muted)}
  .panel .actions{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
  .tag{
    display:inline-block; font-size:12px; padding:6px 10px; border-radius:999px; background:#0b132b; color:var(--muted); margin-right:6px; margin-top:6px;
  }
  .countdown{
    position:fixed; inset:0; display:grid; place-items:center; z-index:4; pointer-events:none;
    font-weight:900; font-size:18vw; line-height:1; color:#ffffff;
    text-shadow: 0 10px 40px rgba(0,0,0,.55);
  }
  /* Thumb lanes hint */
  .lanes{
    position:fixed; inset:0; display:flex; opacity:.05; pointer-events:none;
  }
  .lanes > div{flex:1; border-left:1px dashed #fff; border-right:1px dashed #fff}
  @media (max-width:420px){
    .score .big{font-size:24px}
    .btn{padding:10px 12px}
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <!-- faint lanes to hint left/right thumb zones -->
  <div class="lanes" aria-hidden="true">
    <div></div><div></div>
  </div>

  <div class="hud" aria-live="polite">
    <div class="row">
      <div class="cluster">
        <button class="btn ghost" id="btnHelp" aria-label="How to play">‚ùì</button>
        <button class="btn ghost" id="btnSettings" aria-label="Settings">‚öôÔ∏è</button>
      </div>
      <div class="score">
        <div class="big"><span id="score">0</span></div>
        <div class="small">Best <span id="best">0</span></div>
      </div>
      <div class="cluster">
        <button class="btn" id="btnPause" aria-label="Pause">‚è∏Ô∏è</button>
        <button class="btn red" id="btnRestart" aria-label="Restart">‚Üª</button>
      </div>
    </div>
    <div class="bottom-cta">
      <button class="btn green" id="btnStart">‚ñ∂ Start</button>
    </div>
  </div>

  <!-- Countdown -->
  <div id="countdown" class="countdown" hidden>3</div>

  <!-- Help / How to play -->
  <div id="help" class="overlay" hidden>
    <div class="panel">
      <h1>Two-Thumb Pong</h1>
      <p>Use both thumbs at the same time. Touch and drag in the left and right halves of the screen to move each puck up and down. Keep the ball bouncing between them. Each successful bounce = +1.</p>
      <div>
        <span class="tag">Tip: touch anywhere on each side</span>
        <span class="tag">Hits add ‚Äúspin‚Äù for control</span>
        <span class="tag">Speed ramps up</span>
      </div>
      <div class="actions">
        <button class="btn green" id="helpPlay">Play</button>
        <button class="btn ghost" id="helpClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings" class="overlay" hidden>
    <div class="panel">
      <h1>Settings</h1>
      <p>Adjust preferences.</p>
      <div class="actions">
        <button class="btn" id="toggleSound">üîä Sound: <span id="soundState">On</span></button>
        <button class="btn" id="toggleVib">üì≥ Vibration: <span id="vibState">On</span></button>
        <button class="btn ghost" id="settingsClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Game Over -->
  <div id="gameover" class="overlay" hidden>
    <div class="panel">
      <h1>Game Over</h1>
      <p>Score: <strong id="finalScore">0</strong></p>
      <p>Best: <strong id="finalBest">0</strong></p>
      <div class="actions">
        <button class="btn green" id="again">Play Again</button>
        <button class="btn ghost" id="overClose">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Utility / Audio / Haptics ---------- */
const store = {
  get(k, d){ try{ const v = localStorage.getItem(k); return v===null?d:JSON.parse(v);}catch{ return d } },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
};
let audioCtx = null;
function ping(freq=440, dur=0.06, vol=0.08){
  if(!settings.sound) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.value = freq;
    gain.gain.setValueAtTime(0, t0);
    gain.gain.linearRampToValueAtTime(vol, t0+0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    osc.connect(gain).connect(audioCtx.destination);
    osc.start(t0); osc.stop(t0+dur);
  }catch{}
}
function vibrate(ms=15){ if(settings.vibrate && navigator.vibrate) navigator.vibrate(ms); }

/* ---------- DOM ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
const $ = sel => document.querySelector(sel);
const elScore = $('#score'), elBest = $('#best');
const elStart = $('#btnStart'), elPause = $('#btnPause'), elRestart = $('#btnRestart');
const elHelp = $('#help'), elSettings = $('#settings'), elGameOver = $('#gameover');
const elHelpPlay = $('#helpPlay'), elHelpClose=$('#helpClose');
const elSettingsClose=$('#settingsClose'), elToggleSound=$('#toggleSound'), elSoundState=$('#soundState');
const elToggleVib=$('#toggleVib'), elVibState=$('#vibState');
const elBtnHelp=$('#btnHelp'), elBtnSettings=$('#btnSettings');
const elFinalScore=$('#finalScore'), elFinalBest=$('#finalBest');
const elAgain=$('#again'), elOverClose=$('#overClose');
const elCountdown = $('#countdown');

let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

/* ---------- Game State ---------- */
const settings = {
  sound: store.get('tt_sound', true),
  vibrate: store.get('tt_vibe', true),
};
let best = store.get('tt_best', 0);
elBest.textContent = best;

const GameState = { Ready:0, Countdown:1, Playing:2, Paused:3, Over:4 };
let state = GameState.Ready;
let score = 0;
let lastT = 0;
let raf = null;
let countdownT = 0;
let countdownVal = 3;
let touches = new Map(); // id -> {side:'L'|'R', y}

const world = {
  w: 0, h: 0, pad: 16,
  ball: { x:0, y:0, r:10, vx:360, vy:0, speed:360, speedMax:1400 },
  left:  { x:0, y:0, r:28, color:'#6ee7ff' },
  right: { x:0, y:0, r:28, color:'#a3ff7e' },
  wallTop: 0, wallBottom: 0,
  margin: 22
};

/* ---------- Resize / DPR ---------- */
function fit(){
  DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const cssW = window.innerWidth, cssH = window.innerHeight;
  canvas.width = Math.floor(cssW * DPR);
  canvas.height = Math.floor(cssH * DPR);
  canvas.style.width = cssW + 'px';
  canvas.style.height = cssH + 'px';
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(DPR, DPR);

  world.w = cssW; world.h = cssH;
  world.wallTop = 0 + world.margin;
  world.wallBottom = cssH - world.margin;
  const edge = 32;
  world.left.x = edge;
  world.right.x = cssW - edge;
  world.left.y = cssH/2;
  world.right.y = cssH/2;

  if(state === GameState.Ready || state === GameState.Over){
    placeBall(true);
    render(0); // draw idle frame
  }
}
window.addEventListener('resize', fit);
fit();

/* ---------- Controls ---------- */
function openOverlay(el){ el.hidden = false; }
function closeOverlay(el){ el.hidden = true; }

elBtnHelp.onclick = () => openOverlay(elHelp);
elHelpClose.onclick = () => closeOverlay(elHelp);
elHelpPlay.onclick = () => { closeOverlay(elHelp); startFlow(); };

elBtnSettings.onclick = () => { elSoundState.textContent = settings.sound?'On':'Off'; elVibState.textContent = settings.vibrate?'On':'Off'; openOverlay(elSettings); };
elSettingsClose.onclick = () => closeOverlay(elSettings);
elToggleSound.onclick = () => { settings.sound = !settings.sound; store.set('tt_sound', settings.sound); elSoundState.textContent = settings.sound?'On':'Off'; ping(660, .05, .12); };
elToggleVib.onclick = () => { settings.vibrate = !settings.vibrate; store.set('tt_vibe', settings.vibrate); elVibState.textContent = settings.vibrate?'On':'Off'; vibrate(12); };

elStart.onclick = () => startFlow();
elRestart.onclick = () => resetGame(true);
elPause.onclick = () => togglePause();
elAgain.onclick = () => { closeOverlay(elGameOver); resetGame(true); };
elOverClose.onclick = () => closeOverlay(elGameOver);

function startFlow(){
  if(state === GameState.Playing) return;
  closeOverlay(elHelp);
  closeOverlay(elSettings);
  closeOverlay(elGameOver);
  elStart.blur();
  startCountdown();
}
function startCountdown(){
  state = GameState.Countdown;
  countdownVal = 3;
  elCountdown.hidden = false;
  elCountdown.textContent = countdownVal;
  countdownT = performance.now();
  ping(660, .08, .12);
  scheduleLoop();
}
function beginPlay(){
  state = GameState.Playing;
  elCountdown.hidden = true;
  lastT = performance.now();
  ping(880, .06, .12);
}
function togglePause(){
  if(state === GameState.Playing){
    state = GameState.Paused;
    elPause.textContent = '‚ñ∂Ô∏è';
  }else if(state === GameState.Paused){
    state = GameState.Playing;
    lastT = performance.now();
    elPause.textContent = '‚è∏Ô∏è';
    scheduleLoop();
  }
}
function gameOver(){
  state = GameState.Over;
  ping(160, .12, .15); vibrate(40);
  best = Math.max(best, score); store.set('tt_best', best);
  elFinalScore.textContent = score; elFinalBest.textContent = best;
  elBest.textContent = best;
  openOverlay(elGameOver);
}

function resetGame(andCountdown=false){
  score = 0; elScore.textContent = score;
  placeBall(true);
  state = GameState.Ready;
  elPause.textContent = '‚è∏Ô∏è';
  if(andCountdown) startCountdown(); else render(0);
}

function placeBall(randomDir=false){
  world.ball.x = world.w/2;
  world.ball.y = world.h/2;
  world.ball.speed = 360;
  const sign = randomDir ? (Math.random()<0.5?-1:1) : 1;
  world.ball.vx = sign * world.ball.speed;
  world.ball.vy = (Math.random()*2 - 1) * 120;
}

/* ---------- Touch / Mouse for both sides ---------- */
function sideFromX(x){ return x < (world.w/2) ? 'L' : 'R'; }

function updatePuck(side, y){
  y = Math.max(world.wallTop, Math.min(world.wallBottom, y));
  if(side==='L') world.left.y = y; else world.right.y = y;
}
function handleStart(id,x,y){
  const side = sideFromX(x);
  touches.set(id, {side, y});
  updatePuck(side, y);
}
function handleMove(id,x,y){
  const t = touches.get(id);
  if(!t) return;
  t.y = y; updatePuck(t.side, y);
}
function handleEnd(id){
  touches.delete(id);
}

canvas.addEventListener('touchstart', (e)=>{
  e.preventDefault();
  for(const touch of e.changedTouches){
    const rect = canvas.getBoundingClientRect();
    handleStart(touch.identifier, touch.clientX - rect.left, touch.clientY - rect.top);
  }
}, {passive:false});
canvas.addEventListener('touchmove', (e)=>{
  e.preventDefault();
  for(const touch of e.changedTouches){
    const rect = canvas.getBoundingClientRect();
    handleMove(touch.identifier, touch.clientX - rect.left, touch.clientY - rect.top);
  }
}, {passive:false});
canvas.addEventListener('touchend', (e)=>{
  e.preventDefault();
  for(const touch of e.changedTouches) handleEnd(touch.identifier);
}, {passive:false});
canvas.addEventListener('touchcancel', (e)=>{
  e.preventDefault();
  for(const touch of e.changedTouches) handleEnd(touch.identifier);
}, {passive:false});

/* Mouse support for desktop testing */
let mouseDownL=false, mouseDownR=false;
canvas.addEventListener('mousedown', e=>{
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  const side = sideFromX(x);
  if(side==='L') mouseDownL=true; else mouseDownR=true;
  updatePuck(side, y);
});
canvas.addEventListener('mousemove', e=>{
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  if(mouseDownL && x < world.w/2) updatePuck('L', y);
  if(mouseDownR && x >= world.w/2) updatePuck('R', y);
});
window.addEventListener('mouseup', ()=>{
  mouseDownL=false; mouseDownR=false;
});

/* ---------- Physics ---------- */
function step(dt){
  if(state === GameState.Countdown){
    const now = performance.now();
    if(now - countdownT >= 1000){
      countdownT += 1000;
      countdownVal--;
      if(countdownVal>0){
        elCountdown.textContent = countdownVal;
        ping(660, .06, .12);
      }else{
        beginPlay();
      }
    }
    return;
  }
  if(state !== GameState.Playing) return;

  // move ball
  world.ball.x += world.ball.vx * dt;
  world.ball.y += world.ball.vy * dt;

  // collide top/bottom
  if(world.ball.y - world.ball.r <= world.wallTop){
    world.ball.y = world.wallTop + world.ball.r;
    world.ball.vy = Math.abs(world.ball.vy);
    ping(520, .03, .07);
  }
  if(world.ball.y + world.ball.r >= world.wallBottom){
    world.ball.y = world.wallBottom - world.ball.r;
    world.ball.vy = -Math.abs(world.ball.vy);
    ping(520, .03, .07);
  }

  // collide left puck
  const L = world.left, R = world.right, b = world.ball;
  // Check near left edge
  if(b.vx < 0 && b.x - b.r <= L.x + L.r){
    const dy = b.y - L.y;
    if(Math.abs(dy) <= L.r + b.r){
      // reflect
      b.x = L.x + L.r + b.r;
      b.vx = Math.abs(b.vx);
      // add spin
      b.vy += dy * 4.2;
      // speed up
      b.speed = Math.min(world.ball.speedMax, Math.hypot(b.vx, b.vy) * 1.045);
      const ang = Math.atan2(b.vy, b.vx);
      b.vx = Math.cos(ang) * b.speed;
      b.vy = Math.sin(ang) * b.speed;
      onHit();
    }
  }
  // collide right puck
  if(b.vx > 0 && b.x + b.r >= R.x - R.r){
    const dy = b.y - R.y;
    if(Math.abs(dy) <= R.r + b.r){
      b.x = R.x - R.r - b.r;
      b.vx = -Math.abs(b.vx);
      b.vy += dy * 4.2;
      b.speed = Math.min(world.ball.speedMax, Math.hypot(b.vx, b.vy) * 1.045);
      const ang = Math.atan2(b.vy, b.vx);
      b.vx = Math.cos(ang) * b.speed;
      b.vy = Math.sin(ang) * b.speed;
      onHit();
    }
  }

  // miss -> out of bounds
  if(b.x + b.r < 0 || b.x - b.r > world.w){
    onMiss();
  }
}
function onHit(){
  score++; elScore.textContent = score;
  ping(740, .04, .09); vibrate(10);
}
function onMiss(){
  gameOver();
}

/* ---------- Render ---------- */
function render(dt){
  const w = world.w, h = world.h;
  // background gradient
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, '#0b1020');
  g.addColorStop(1, '#111a3a');
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

  // side separators (faint)
  ctx.globalAlpha = 0.08;
  ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 1;
  ctx.setLineDash([6,8]);
  ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke();
  ctx.setLineDash([]);
  ctx.globalAlpha = 1;

  // walls
  ctx.globalAlpha = 0.12;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, world.wallTop-4, w, 4);
  ctx.fillRect(0, world.wallBottom, w, 4);
  ctx.globalAlpha = 1;

  // pucks
  drawPuck(world.left.x, world.left.y, world.left.r, world.left.color);
  drawPuck(world.right.x, world.right.y, world.right.r, world.right.color);

  // ball
  drawBall(world.ball.x, world.ball.y, world.ball.r);

  // subtle trail or glow
}
function drawPuck(x,y,r, color){
  ctx.shadowColor = color; ctx.shadowBlur = 20;
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
}
function drawBall(x,y,r){
  ctx.shadowColor = '#ffd86b'; ctx.shadowBlur = 18;
  const radial = ctx.createRadialGradient(x-r/3, y-r/3, r*0.2, x, y, r);
  radial.addColorStop(0, '#fff6d0');
  radial.addColorStop(1, '#ffb703');
  ctx.fillStyle = radial;
  ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
}

/* ---------- Loop ---------- */
function loop(t){
  if(state === GameState.Paused){ raf = null; return; }
  if(!lastT) lastT = t;
  const dt = Math.min(0.033, (t - lastT)/1000);
  lastT = t;
  step(dt);
  render(dt);
  scheduleLoop();
}
function scheduleLoop(){ if(!raf) raf = requestAnimationFrame((ts)=>{ raf=null; loop(ts); }); }

/* ---------- Init ---------- */
placeBall(true);
render(0);

/* Prevent iOS zoom gesture */
document.addEventListener('gesturestart', e=>e.preventDefault());
document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});

/* Start on first user interaction for audio unlock */
window.addEventListener('pointerdown', ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});

/* Optional: show help on very first visit */
if(!store.get('tt_seen', false)){ openOverlay(elHelp); store.set('tt_seen', true); }

/* Keyboard helpers for desktop */
window.addEventListener('keydown', e=>{
  if(e.code==='Space'){ if(state===GameState.Playing) togglePause(); else startFlow(); }
  if(e.code==='KeyR') resetGame(true);
});

/* ---------- End ---------- */
</script>
</body>
</html>
